{
 "Description": "RelayStack AI Gateway Infrastructure - Cognito, RDS, ElastiCache, S3",
 "Resources": {
  "RelayStackVpcAF1A8530": {
   "Type": "AWS::EC2::VPC",
   "Properties": {
    "CidrBlock": "10.0.0.0/16",
    "EnableDnsHostnames": true,
    "EnableDnsSupport": true,
    "InstanceTenancy": "default",
    "Tags": [
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/Resource"
   }
  },
  "RelayStackVpcPublicSubnet1Subnet1CDFA9A9": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": "us-east-2a",
    "CidrBlock": "10.0.0.0/24",
    "MapPublicIpOnLaunch": true,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Public"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Public"
     },
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PublicSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet1/Subnet"
   }
  },
  "RelayStackVpcPublicSubnet1RouteTable165088C0": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PublicSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet1/RouteTable"
   }
  },
  "RelayStackVpcPublicSubnet1RouteTableAssociationEB78FE7B": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "RelayStackVpcPublicSubnet1RouteTable165088C0"
    },
    "SubnetId": {
     "Ref": "RelayStackVpcPublicSubnet1Subnet1CDFA9A9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet1/RouteTableAssociation"
   }
  },
  "RelayStackVpcPublicSubnet1DefaultRoute608182DC": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "GatewayId": {
     "Ref": "RelayStackVpcIGWDB6CBCA4"
    },
    "RouteTableId": {
     "Ref": "RelayStackVpcPublicSubnet1RouteTable165088C0"
    }
   },
   "DependsOn": [
    "RelayStackVpcVPCGWFBE42D63"
   ],
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet1/DefaultRoute"
   }
  },
  "RelayStackVpcPublicSubnet1EIP1A7CEB53": {
   "Type": "AWS::EC2::EIP",
   "Properties": {
    "Domain": "vpc",
    "Tags": [
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PublicSubnet1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet1/EIP"
   }
  },
  "RelayStackVpcPublicSubnet1NATGateway5401E8FF": {
   "Type": "AWS::EC2::NatGateway",
   "Properties": {
    "AllocationId": {
     "Fn::GetAtt": [
      "RelayStackVpcPublicSubnet1EIP1A7CEB53",
      "AllocationId"
     ]
    },
    "SubnetId": {
     "Ref": "RelayStackVpcPublicSubnet1Subnet1CDFA9A9"
    },
    "Tags": [
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PublicSubnet1"
     }
    ]
   },
   "DependsOn": [
    "RelayStackVpcPublicSubnet1DefaultRoute608182DC",
    "RelayStackVpcPublicSubnet1RouteTableAssociationEB78FE7B"
   ],
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet1/NATGateway"
   }
  },
  "RelayStackVpcPublicSubnet2Subnet0437F672": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": "us-east-2b",
    "CidrBlock": "10.0.1.0/24",
    "MapPublicIpOnLaunch": true,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Public"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Public"
     },
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PublicSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet2/Subnet"
   }
  },
  "RelayStackVpcPublicSubnet2RouteTableF9C4C57B": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PublicSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet2/RouteTable"
   }
  },
  "RelayStackVpcPublicSubnet2RouteTableAssociation8727E217": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "RelayStackVpcPublicSubnet2RouteTableF9C4C57B"
    },
    "SubnetId": {
     "Ref": "RelayStackVpcPublicSubnet2Subnet0437F672"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet2/RouteTableAssociation"
   }
  },
  "RelayStackVpcPublicSubnet2DefaultRoute2D339023": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "GatewayId": {
     "Ref": "RelayStackVpcIGWDB6CBCA4"
    },
    "RouteTableId": {
     "Ref": "RelayStackVpcPublicSubnet2RouteTableF9C4C57B"
    }
   },
   "DependsOn": [
    "RelayStackVpcVPCGWFBE42D63"
   ],
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PublicSubnet2/DefaultRoute"
   }
  },
  "RelayStackVpcPrivateSubnet1SubnetD37DA11D": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": "us-east-2a",
    "CidrBlock": "10.0.2.0/24",
    "MapPublicIpOnLaunch": false,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Private"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Private"
     },
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PrivateSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PrivateSubnet1/Subnet"
   }
  },
  "RelayStackVpcPrivateSubnet1RouteTable6C90AB29": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PrivateSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PrivateSubnet1/RouteTable"
   }
  },
  "RelayStackVpcPrivateSubnet1RouteTableAssociationBDE9C869": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "RelayStackVpcPrivateSubnet1RouteTable6C90AB29"
    },
    "SubnetId": {
     "Ref": "RelayStackVpcPrivateSubnet1SubnetD37DA11D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PrivateSubnet1/RouteTableAssociation"
   }
  },
  "RelayStackVpcPrivateSubnet1DefaultRoute69C9385D": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "NatGatewayId": {
     "Ref": "RelayStackVpcPublicSubnet1NATGateway5401E8FF"
    },
    "RouteTableId": {
     "Ref": "RelayStackVpcPrivateSubnet1RouteTable6C90AB29"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PrivateSubnet1/DefaultRoute"
   }
  },
  "RelayStackVpcPrivateSubnet2Subnet943561E3": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": "us-east-2b",
    "CidrBlock": "10.0.3.0/24",
    "MapPublicIpOnLaunch": false,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Private"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Private"
     },
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PrivateSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PrivateSubnet2/Subnet"
   }
  },
  "RelayStackVpcPrivateSubnet2RouteTable33DBCE8B": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc/PrivateSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PrivateSubnet2/RouteTable"
   }
  },
  "RelayStackVpcPrivateSubnet2RouteTableAssociation8083B9B9": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "RelayStackVpcPrivateSubnet2RouteTable33DBCE8B"
    },
    "SubnetId": {
     "Ref": "RelayStackVpcPrivateSubnet2Subnet943561E3"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PrivateSubnet2/RouteTableAssociation"
   }
  },
  "RelayStackVpcPrivateSubnet2DefaultRoute7DF841C6": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "NatGatewayId": {
     "Ref": "RelayStackVpcPublicSubnet1NATGateway5401E8FF"
    },
    "RouteTableId": {
     "Ref": "RelayStackVpcPrivateSubnet2RouteTable33DBCE8B"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/PrivateSubnet2/DefaultRoute"
   }
  },
  "RelayStackVpcIGWDB6CBCA4": {
   "Type": "AWS::EC2::InternetGateway",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "RelayStackInfra/RelayStackVpc"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/IGW"
   }
  },
  "RelayStackVpcVPCGWFBE42D63": {
   "Type": "AWS::EC2::VPCGatewayAttachment",
   "Properties": {
    "InternetGatewayId": {
     "Ref": "RelayStackVpcIGWDB6CBCA4"
    },
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackVpc/VPCGW"
   }
  },
  "AlbSecurityGroup86A59E99": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "Security group for Application Load Balancer",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "SecurityGroupIngress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow HTTP",
      "FromPort": 80,
      "IpProtocol": "tcp",
      "ToPort": 80
     },
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow HTTPS",
      "FromPort": 443,
      "IpProtocol": "tcp",
      "ToPort": 443
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/AlbSecurityGroup/Resource"
   }
  },
  "EcsSecurityGroup44008BF1": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "Security group for ECS Fargate tasks",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/EcsSecurityGroup/Resource"
   }
  },
  "EcsSecurityGroupfromRelayStackInfraAlbSecurityGroupE502F7B68080A6E834E5": {
   "Type": "AWS::EC2::SecurityGroupIngress",
   "Properties": {
    "Description": "Allow traffic from ALB",
    "FromPort": 8080,
    "GroupId": {
     "Fn::GetAtt": [
      "EcsSecurityGroup44008BF1",
      "GroupId"
     ]
    },
    "IpProtocol": "tcp",
    "SourceSecurityGroupId": {
     "Fn::GetAtt": [
      "AlbSecurityGroup86A59E99",
      "GroupId"
     ]
    },
    "ToPort": 8080
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/EcsSecurityGroup/from RelayStackInfraAlbSecurityGroupE502F7B6:8080"
   }
  },
  "DbSecurityGroupE9D701AD": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "Security group for RDS PostgreSQL",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/DbSecurityGroup/Resource"
   }
  },
  "DbSecurityGroupfromRelayStackInfraEcsSecurityGroupF8B57748543297C1B8D8": {
   "Type": "AWS::EC2::SecurityGroupIngress",
   "Properties": {
    "Description": "Allow PostgreSQL from ECS",
    "FromPort": 5432,
    "GroupId": {
     "Fn::GetAtt": [
      "DbSecurityGroupE9D701AD",
      "GroupId"
     ]
    },
    "IpProtocol": "tcp",
    "SourceSecurityGroupId": {
     "Fn::GetAtt": [
      "EcsSecurityGroup44008BF1",
      "GroupId"
     ]
    },
    "ToPort": 5432
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/DbSecurityGroup/from RelayStackInfraEcsSecurityGroupF8B57748:5432"
   }
  },
  "DbCredentials798065DE": {
   "Type": "AWS::SecretsManager::Secret",
   "Properties": {
    "Description": "RelayStack RDS PostgreSQL credentials",
    "GenerateSecretString": {
     "ExcludePunctuation": true,
     "GenerateStringKey": "password",
     "PasswordLength": 32,
     "SecretStringTemplate": "{\"username\":\"relaystack\"}"
    },
    "Name": "relaystack/db-credentials"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/DbCredentials/Resource"
   }
  },
  "DbCredentialsAttachmentD2151D4F": {
   "Type": "AWS::SecretsManager::SecretTargetAttachment",
   "Properties": {
    "SecretId": {
     "Ref": "DbCredentials798065DE"
    },
    "TargetId": {
     "Ref": "RelayStackDb1FC49FBE"
    },
    "TargetType": "AWS::RDS::DBInstance"
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/DbCredentials/Attachment/Resource"
   }
  },
  "RelayStackDbSubnetGroup1C817676": {
   "Type": "AWS::RDS::DBSubnetGroup",
   "Properties": {
    "DBSubnetGroupDescription": "Subnet group for RelayStackDb database",
    "SubnetIds": [
     {
      "Ref": "RelayStackVpcPrivateSubnet1SubnetD37DA11D"
     },
     {
      "Ref": "RelayStackVpcPrivateSubnet2Subnet943561E3"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackDb/SubnetGroup/Default"
   }
  },
  "RelayStackDb1FC49FBE": {
   "Type": "AWS::RDS::DBInstance",
   "Properties": {
    "AllocatedStorage": "20",
    "AutoMinorVersionUpgrade": true,
    "BackupRetentionPeriod": 7,
    "CopyTagsToSnapshot": true,
    "DBInstanceClass": "db.t3.micro",
    "DBName": "relaystack",
    "DBSubnetGroupName": {
     "Ref": "RelayStackDbSubnetGroup1C817676"
    },
    "DeletionProtection": false,
    "Engine": "postgres",
    "EngineVersion": "16",
    "MasterUserPassword": {
     "Fn::Join": [
      "",
      [
       "{{resolve:secretsmanager:",
       {
        "Ref": "DbCredentials798065DE"
       },
       ":SecretString:password::}}"
      ]
     ]
    },
    "MasterUsername": {
     "Fn::Join": [
      "",
      [
       "{{resolve:secretsmanager:",
       {
        "Ref": "DbCredentials798065DE"
       },
       ":SecretString:username::}}"
      ]
     ]
    },
    "MaxAllocatedStorage": 100,
    "MultiAZ": false,
    "PubliclyAccessible": false,
    "StorageEncrypted": true,
    "StorageType": "gp2",
    "VPCSecurityGroups": [
     {
      "Fn::GetAtt": [
       "DbSecurityGroupE9D701AD",
       "GroupId"
      ]
     }
    ]
   },
   "UpdateReplacePolicy": "Snapshot",
   "DeletionPolicy": "Snapshot",
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackDb/Resource"
   }
  },
  "JwtSecretB8834B39": {
   "Type": "AWS::SecretsManager::Secret",
   "Properties": {
    "Description": "JWT signing secret for RelayStack auth",
    "GenerateSecretString": {
     "ExcludePunctuation": true,
     "PasswordLength": 64
    },
    "Name": "relaystack/jwt-secret"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/JwtSecret/Resource"
   }
  },
  "GatewayRepo5C3BAF10": {
   "Type": "AWS::ECR::Repository",
   "Properties": {
    "EmptyOnDelete": true,
    "ImageScanningConfiguration": {
     "ScanOnPush": true
    },
    "LifecyclePolicy": {
     "LifecyclePolicyText": "{\"rules\":[{\"rulePriority\":1,\"description\":\"Keep only 10 images\",\"selection\":{\"tagStatus\":\"any\",\"countType\":\"imageCountMoreThan\",\"countNumber\":10},\"action\":{\"type\":\"expire\"}}]}"
    },
    "RepositoryName": "relaystack-gateway"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayRepo/Resource"
   }
  },
  "RelayStackClusterFBC07A44": {
   "Type": "AWS::ECS::Cluster",
   "Properties": {
    "ClusterName": "relaystack-cluster"
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackCluster/Resource"
   }
  },
  "RelayStackAlb4C4FE321": {
   "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
   "Properties": {
    "LoadBalancerAttributes": [
     {
      "Key": "deletion_protection.enabled",
      "Value": "false"
     }
    ],
    "Name": "relaystack-alb",
    "Scheme": "internet-facing",
    "SecurityGroups": [
     {
      "Fn::GetAtt": [
       "AlbSecurityGroup86A59E99",
       "GroupId"
      ]
     }
    ],
    "Subnets": [
     {
      "Ref": "RelayStackVpcPublicSubnet1Subnet1CDFA9A9"
     },
     {
      "Ref": "RelayStackVpcPublicSubnet2Subnet0437F672"
     }
    ],
    "Type": "application"
   },
   "DependsOn": [
    "RelayStackVpcPublicSubnet1DefaultRoute608182DC",
    "RelayStackVpcPublicSubnet1RouteTableAssociationEB78FE7B",
    "RelayStackVpcPublicSubnet2DefaultRoute2D339023",
    "RelayStackVpcPublicSubnet2RouteTableAssociation8727E217"
   ],
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackAlb/Resource"
   }
  },
  "RelayStackAlbHttpListenerF8CD664D": {
   "Type": "AWS::ElasticLoadBalancingV2::Listener",
   "Properties": {
    "DefaultActions": [
     {
      "TargetGroupArn": {
       "Ref": "RelayStackAlbHttpListenerGatewayTargetGroupC7C211B4"
      },
      "Type": "forward"
     }
    ],
    "LoadBalancerArn": {
     "Ref": "RelayStackAlb4C4FE321"
    },
    "Port": 80,
    "Protocol": "HTTP"
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackAlb/HttpListener/Resource"
   }
  },
  "RelayStackAlbHttpListenerGatewayTargetGroupC7C211B4": {
   "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
   "Properties": {
    "HealthCheckIntervalSeconds": 30,
    "HealthCheckPath": "/health",
    "HealthCheckTimeoutSeconds": 5,
    "HealthyThresholdCount": 2,
    "Port": 8080,
    "Protocol": "HTTP",
    "TargetGroupAttributes": [
     {
      "Key": "stickiness.enabled",
      "Value": "false"
     }
    ],
    "TargetType": "ip",
    "UnhealthyThresholdCount": 3,
    "VpcId": {
     "Ref": "RelayStackVpcAF1A8530"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/RelayStackAlb/HttpListener/GatewayTargetGroup/Resource"
   }
  },
  "GatewayTaskDefTaskRoleDCA38114": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayTaskDef/TaskRole/Resource"
   }
  },
  "GatewayTaskDefTaskRoleDefaultPolicy68852739": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
       ],
       "Effect": "Allow",
       "Resource": {
        "Ref": "DbCredentials798065DE"
       }
      },
      {
       "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
       ],
       "Effect": "Allow",
       "Resource": {
        "Ref": "JwtSecretB8834B39"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "GatewayTaskDefTaskRoleDefaultPolicy68852739",
    "Roles": [
     {
      "Ref": "GatewayTaskDefTaskRoleDCA38114"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayTaskDef/TaskRole/DefaultPolicy/Resource"
   }
  },
  "GatewayTaskDef527EC7C6": {
   "Type": "AWS::ECS::TaskDefinition",
   "Properties": {
    "ContainerDefinitions": [
     {
      "Environment": [
       {
        "Name": "NODE_ENV",
        "Value": "production"
       },
       {
        "Name": "PORT",
        "Value": "8080"
       },
       {
        "Name": "AWS_REGION",
        "Value": {
         "Ref": "AWS::Region"
        }
       },
       {
        "Name": "DB_HOST",
        "Value": {
         "Fn::GetAtt": [
          "RelayStackDb1FC49FBE",
          "Endpoint.Address"
         ]
        }
       },
       {
        "Name": "DB_PORT",
        "Value": {
         "Fn::GetAtt": [
          "RelayStackDb1FC49FBE",
          "Endpoint.Port"
         ]
        }
       },
       {
        "Name": "DB_NAME",
        "Value": "relaystack"
       }
      ],
      "Essential": true,
      "HealthCheck": {
       "Command": [
        "CMD-SHELL",
        "curl -f http://localhost:8080/health || exit 1"
       ],
       "Interval": 30,
       "Retries": 3,
       "StartPeriod": 60,
       "Timeout": 5
      },
      "Image": {
       "Fn::Join": [
        "",
        [
         {
          "Fn::Select": [
           4,
           {
            "Fn::Split": [
             ":",
             {
              "Fn::GetAtt": [
               "GatewayRepo5C3BAF10",
               "Arn"
              ]
             }
            ]
           }
          ]
         },
         ".dkr.ecr.",
         {
          "Fn::Select": [
           3,
           {
            "Fn::Split": [
             ":",
             {
              "Fn::GetAtt": [
               "GatewayRepo5C3BAF10",
               "Arn"
              ]
             }
            ]
           }
          ]
         },
         ".",
         {
          "Ref": "AWS::URLSuffix"
         },
         "/",
         {
          "Ref": "GatewayRepo5C3BAF10"
         },
         ":20260205212731"
        ]
       ]
      },
      "LogConfiguration": {
       "LogDriver": "awslogs",
       "Options": {
        "awslogs-group": {
         "Ref": "GatewayTaskDefGatewayContainerLogGroup93388743"
        },
        "awslogs-stream-prefix": "gateway",
        "awslogs-region": "us-east-2"
       }
      },
      "Name": "GatewayContainer",
      "PortMappings": [
       {
        "ContainerPort": 8080,
        "Protocol": "tcp"
       }
      ],
      "Secrets": [
       {
        "Name": "DB_USERNAME",
        "ValueFrom": {
         "Fn::Join": [
          "",
          [
           {
            "Ref": "DbCredentials798065DE"
           },
           ":username::"
          ]
         ]
        }
       },
       {
        "Name": "DB_PASSWORD",
        "ValueFrom": {
         "Fn::Join": [
          "",
          [
           {
            "Ref": "DbCredentials798065DE"
           },
           ":password::"
          ]
         ]
        }
       },
       {
        "Name": "JWT_SECRET",
        "ValueFrom": {
         "Ref": "JwtSecretB8834B39"
        }
       }
      ]
     }
    ],
    "Cpu": "512",
    "ExecutionRoleArn": {
     "Fn::GetAtt": [
      "GatewayTaskDefExecutionRoleBF9BD2B7",
      "Arn"
     ]
    },
    "Family": "RelayStackInfraGatewayTaskDef90A75AD0",
    "Memory": "1024",
    "NetworkMode": "awsvpc",
    "RequiresCompatibilities": [
     "FARGATE"
    ],
    "TaskRoleArn": {
     "Fn::GetAtt": [
      "GatewayTaskDefTaskRoleDCA38114",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayTaskDef/Resource"
   }
  },
  "GatewayTaskDefGatewayContainerLogGroup93388743": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "RetentionInDays": 7
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayTaskDef/GatewayContainer/LogGroup/Resource"
   }
  },
  "GatewayTaskDefExecutionRoleBF9BD2B7": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayTaskDef/ExecutionRole/Resource"
   }
  },
  "GatewayTaskDefExecutionRoleDefaultPolicyBB80EE04": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ecr:BatchCheckLayerAvailability",
        "ecr:GetDownloadUrlForLayer",
        "ecr:BatchGetImage"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "GatewayRepo5C3BAF10",
         "Arn"
        ]
       }
      },
      {
       "Action": "ecr:GetAuthorizationToken",
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "GatewayTaskDefGatewayContainerLogGroup93388743",
         "Arn"
        ]
       }
      },
      {
       "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
       ],
       "Effect": "Allow",
       "Resource": {
        "Ref": "DbCredentials798065DE"
       }
      },
      {
       "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
       ],
       "Effect": "Allow",
       "Resource": {
        "Ref": "JwtSecretB8834B39"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "GatewayTaskDefExecutionRoleDefaultPolicyBB80EE04",
    "Roles": [
     {
      "Ref": "GatewayTaskDefExecutionRoleBF9BD2B7"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayTaskDef/ExecutionRole/DefaultPolicy/Resource"
   }
  },
  "GatewayService20F4B805": {
   "Type": "AWS::ECS::Service",
   "Properties": {
    "Cluster": {
     "Ref": "RelayStackClusterFBC07A44"
    },
    "DeploymentConfiguration": {
     "Alarms": {
      "AlarmNames": [],
      "Enable": false,
      "Rollback": false
     },
     "DeploymentCircuitBreaker": {
      "Enable": true,
      "Rollback": true
     },
     "MaximumPercent": 200,
     "MinimumHealthyPercent": 0
    },
    "DeploymentController": {
     "Type": "ECS"
    },
    "DesiredCount": 1,
    "EnableECSManagedTags": false,
    "HealthCheckGracePeriodSeconds": 60,
    "LaunchType": "FARGATE",
    "LoadBalancers": [
     {
      "ContainerName": "GatewayContainer",
      "ContainerPort": 8080,
      "TargetGroupArn": {
       "Ref": "RelayStackAlbHttpListenerGatewayTargetGroupC7C211B4"
      }
     }
    ],
    "NetworkConfiguration": {
     "AwsvpcConfiguration": {
      "AssignPublicIp": "DISABLED",
      "SecurityGroups": [
       {
        "Fn::GetAtt": [
         "EcsSecurityGroup44008BF1",
         "GroupId"
        ]
       }
      ],
      "Subnets": [
       {
        "Ref": "RelayStackVpcPrivateSubnet1SubnetD37DA11D"
       },
       {
        "Ref": "RelayStackVpcPrivateSubnet2Subnet943561E3"
       }
      ]
     }
    },
    "ServiceName": "relaystack-gateway",
    "TaskDefinition": {
     "Ref": "GatewayTaskDef527EC7C6"
    }
   },
   "DependsOn": [
    "GatewayTaskDefTaskRoleDefaultPolicy68852739",
    "GatewayTaskDefTaskRoleDCA38114",
    "RelayStackAlbHttpListenerGatewayTargetGroupC7C211B4",
    "RelayStackAlbHttpListenerF8CD664D"
   ],
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayService/Service"
   }
  },
  "GatewayServiceTaskCountTarget66688692": {
   "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
   "Properties": {
    "MaxCapacity": 10,
    "MinCapacity": 1,
    "ResourceId": {
     "Fn::Join": [
      "",
      [
       "service/",
       {
        "Ref": "RelayStackClusterFBC07A44"
       },
       "/",
       {
        "Fn::GetAtt": [
         "GatewayService20F4B805",
         "Name"
        ]
       }
      ]
     ]
    },
    "RoleARN": {
     "Fn::Join": [
      "",
      [
       "arn:",
       {
        "Ref": "AWS::Partition"
       },
       ":iam::456735831533:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ]
     ]
    },
    "ScalableDimension": "ecs:service:DesiredCount",
    "ServiceNamespace": "ecs"
   },
   "DependsOn": [
    "GatewayTaskDefTaskRoleDefaultPolicy68852739",
    "GatewayTaskDefTaskRoleDCA38114"
   ],
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayService/TaskCount/Target/Resource"
   }
  },
  "GatewayServiceTaskCountTargetCpuScalingB9A89832": {
   "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
   "Properties": {
    "PolicyName": "RelayStackInfraGatewayServiceTaskCountTargetCpuScalingE70E214E",
    "PolicyType": "TargetTrackingScaling",
    "ScalingTargetId": {
     "Ref": "GatewayServiceTaskCountTarget66688692"
    },
    "TargetTrackingScalingPolicyConfiguration": {
     "PredefinedMetricSpecification": {
      "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
     },
     "ScaleInCooldown": 60,
     "ScaleOutCooldown": 60,
     "TargetValue": 70
    }
   },
   "DependsOn": [
    "GatewayTaskDefTaskRoleDefaultPolicy68852739",
    "GatewayTaskDefTaskRoleDCA38114"
   ],
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/GatewayService/TaskCount/Target/CpuScaling/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/31SwW7bMAz9lt4VbU0H7JwmWxGg2II46HWgFdZjo0iGSCUoBP/7ICuxnRbYiY+PTyL5pLmeP3zX93dw5pnZH2aWap0qAXNQcOY/Cc1cp5fWqOWre9ks1SbWlkwVa4eSuRFtfRTcQW1x5EduwewNgZB3gziDH+tNDr9AnkDwDO9qE+gEguPFaycYHA6CMsklW4iA+XtEJ6pCEwPJ+1Pwse1n+C+xdk1A5k4xmoDCR3DQYNCp6vOLPqMSdhAalEm/QfCx0qmwZ51WIFAD49qxgDOoykrDNKvHT8RV2ik0Qacttp5JfOiXHrNcZp2WNrJgyLUr/AmhgWw5H1b4So6uhn9kvBMgh2HCXc5WGE5kyiNeYGXA5kfMlyx9zBuiBRYy1sO+BgvOkGtOc50WbWvJ9O/87GH/2NfKjDf5VEcs6C6aK57Ui72DS5O0UwRHnba+/Lk+brwl0/tVUKesb1inZ98MV1xxp2BsA1E8G7DkGp3GjXOz3otbpoRdAHMg11Tl3Nj7hug6tUX2MRRXf0dpo3TK+T3qN/5ymn/T9w/6690bE81CdEJH1NsS/wGwRG1coAMAAA=="
   },
   "Metadata": {
    "aws:cdk:path": "RelayStackInfra/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "VpcId": {
   "Description": "VPC ID",
   "Value": {
    "Ref": "RelayStackVpcAF1A8530"
   },
   "Export": {
    "Name": "RelayStackVpcId"
   }
  },
  "AlbDnsName": {
   "Description": "Application Load Balancer DNS Name",
   "Value": {
    "Fn::GetAtt": [
     "RelayStackAlb4C4FE321",
     "DNSName"
    ]
   },
   "Export": {
    "Name": "RelayStackAlbDns"
   }
  },
  "AlbUrl": {
   "Description": "Gateway API URL",
   "Value": {
    "Fn::Join": [
     "",
     [
      "http://",
      {
       "Fn::GetAtt": [
        "RelayStackAlb4C4FE321",
        "DNSName"
       ]
      }
     ]
    ]
   },
   "Export": {
    "Name": "RelayStackGatewayUrl"
   }
  },
  "EcrRepositoryUri": {
   "Description": "ECR Repository URI",
   "Value": {
    "Fn::Join": [
     "",
     [
      {
       "Fn::Select": [
        4,
        {
         "Fn::Split": [
          ":",
          {
           "Fn::GetAtt": [
            "GatewayRepo5C3BAF10",
            "Arn"
           ]
          }
         ]
        }
       ]
      },
      ".dkr.ecr.",
      {
       "Fn::Select": [
        3,
        {
         "Fn::Split": [
          ":",
          {
           "Fn::GetAtt": [
            "GatewayRepo5C3BAF10",
            "Arn"
           ]
          }
         ]
        }
       ]
      },
      ".",
      {
       "Ref": "AWS::URLSuffix"
      },
      "/",
      {
       "Ref": "GatewayRepo5C3BAF10"
      }
     ]
    ]
   },
   "Export": {
    "Name": "RelayStackEcrUri"
   }
  },
  "RdsEndpoint": {
   "Description": "RDS PostgreSQL Endpoint",
   "Value": {
    "Fn::GetAtt": [
     "RelayStackDb1FC49FBE",
     "Endpoint.Address"
    ]
   },
   "Export": {
    "Name": "RelayStackRdsEndpoint"
   }
  },
  "RdsSecretArn": {
   "Description": "RDS Credentials Secret ARN",
   "Value": {
    "Ref": "DbCredentials798065DE"
   },
   "Export": {
    "Name": "RelayStackRdsSecretArn"
   }
  },
  "JwtSecretArn": {
   "Description": "JWT Secret ARN",
   "Value": {
    "Ref": "JwtSecretB8834B39"
   },
   "Export": {
    "Name": "RelayStackJwtSecretArn"
   }
  },
  "ClusterName": {
   "Description": "ECS Cluster Name",
   "Value": {
    "Ref": "RelayStackClusterFBC07A44"
   },
   "Export": {
    "Name": "RelayStackClusterName"
   }
  },
  "ServiceName": {
   "Description": "ECS Service Name",
   "Value": {
    "Fn::GetAtt": [
     "GatewayService20F4B805",
     "Name"
    ]
   },
   "Export": {
    "Name": "RelayStackServiceName"
   }
  },
  "DatabaseUrl": {
   "Description": "Database URL template (replace with actual credentials)",
   "Value": {
    "Fn::Join": [
     "",
     [
      "postgresql://${DB_USERNAME}:${DB_PASSWORD}@",
      {
       "Fn::GetAtt": [
        "RelayStackDb1FC49FBE",
        "Endpoint.Address"
       ]
      },
      ":",
      {
       "Fn::GetAtt": [
        "RelayStackDb1FC49FBE",
        "Endpoint.Port"
       ]
      },
      "/relaystack"
     ]
    ]
   },
   "Export": {
    "Name": "RelayStackDatabaseUrlTemplate"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}